---
title: "Expanded logistic model"
author: "Tim Churches, Sumeet Kalia, David Henderson"
date: "6-12 September 2018"
output:
  html_document:
    df_print: paged
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)

library(tidyverse)
library(magrittr)
library(knitr)
library(feather)
library(speedglm)
library(broom)
library(effects)
```

# Intro

# Expanded model


## Load data

```{r load-data-a}
clean_data <- read_feather(path=here::here("assets/clean_data/clean_data.feather"))
```

```{r subset-data-a, eval=TRUE}
clean_data %<>% sample_frac(size=0.5)
```

```{r expanded_glm-a}
expglm <- glm(dead ~ age_grp + sex + adl_difficulty + worker_class + 
                     vis_minority + first_lang + employ_status + 
                     first_lang + generation + education + loinc_decile + rur_urb +
                     province  + mar_stat + no_kids, 
                     family=binomial(), data=clean_data)

summary(expglm)
```

```{r interaction_glm-a}
interactionglm <- glm(dead ~ age_grp + sex + adl_difficulty + worker_class + 
                     vis_minority + first_lang + employ_status + 
                     first_lang + age_imm + generation + education + loinc_decile + rur_urb +
                     province  + mar_stat + no_fam_members + generation*education, 
                     family=binomial(), data=clean_data)

summary(interactionglm)
```

```{r interaction_glm-b}
anova(expglm, interactionglm, test = "Chi")
```

```{r expline_glm-b}

expglm_df <- tidy(expglm) %>%
              bind_cols(tibble(or=exp(coef(expglm)))) %>%
              bind_cols(as.data.frame(exp(confint.default(expglm)))) %>%
              rename(ci95_lower = "2.5 %", ci95_upper = "97.5 %")

kable(expglm_df)
```

```{r expline_glm-c}
intglm_df <- tidy(interactionglm) %>%
              bind_cols(tibble(or=exp(coef(interactionglm)))) %>%
              bind_cols(as.data.frame(exp(confint.default(interactionglm)))) %>%
              rename(ci95_lower = "2.5 %", ci95_upper = "97.5 %")

kable(intglm_df)
```

```{r save-expglm, eval=TRUE}
save(expglm, file = here::here("assets/clean_data/expglm.rds"))
feather::write_feather(expglm_df, path=here::here("assets/clean_data/expglm_df.feather"))
save(interactionglm, file = here::here("assets/clean_data/intglm.rds"))
feather::write_feather(intglm_df, path=here::here("assets/clean_data/intglm_df.feather"))
```
