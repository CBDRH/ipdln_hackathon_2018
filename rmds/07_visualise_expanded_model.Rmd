---
title: "Visualise expanded model"
author: "David Henderson, Tim Churches, Sumeet Kalia"
date: "6-11 September 2018"
output:
  html_document:
    df_print: paged
    theme: spacelab
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
options(digits = 3)
```

# Intro


##Packages

```{r libs}
library(tidyverse)
library(magrittr)
library(feather)
library(effects)
theme_set(theme_minimal(base_size = 16))
```

##Data

```{r load}
expglm_df <- read_feather(here::here("assets/clean_data/expglm_df.feather"))
expglm_df
```


```{r plot}
orplot <- function(df, slice_range, ref_level="", prefix="", ylab="", sorted=FALSE) {
    df %<>% 
      slice(slice_range) #Start with age groups only
    if (stringr::str_length(prefix) > 0) {
      y_labels <- stringr::str_remove(df$term, prefix) 
      title <- paste("Mortality odds ratio -", ylab)
    } else {
      y_labels <- NULL
      title <- "Mortality odds ratio"
    }
    if(sorted) {
        g <- df %>%  ggplot(aes(or, fct_reorder(term, or)))
    } else {
        g <- df %>%  ggplot(aes(or, term))
    }
      g <- g + geom_vline(aes(xintercept = 1), 
                 size = 0.25, 
                 linetype = "dashed") +
      geom_errorbarh(aes(xmax = ci95_upper, xmin = ci95_lower), 
                    size = 0.5,
                    height = 0.2,
                    colour = "black") +
      geom_point(size = 2, colour = "#4477AA") +
      scale_x_log10(breaks = scales::pretty_breaks())
      if (!is.null(y_labels)) {
        g <- g + scale_y_discrete(labels = y_labels)
      }
      g + labs(title = "Mortality odds ratio",
           subtitle = paste("Reference:",  ref_level),
           y = ylab,
           x = "Odds Ratio (log scale)")
}

y_labels = c("90 plus", "85-89", "80-84", "75-79", "70-74", "65-69",
             "60-64", "55-59", "50-54", "45-49", "40-44", "35-39", "30-34",
             "25-29")

orplot(expglm_df, slice_range=2:15, ref_level="19-24", prefix="age_grp", ylab="Age group")
```


```{r loinc_decile, options}
y_labels <- c("9", "8", "7", "6", "5", "4", "3", "2", "1 - lowest")

orplot(expglm_df, slice_range=59:67, ref_level="Decile 10 - highest", prefix="loinc_decile", ylab="Income decile")
```


```{r province}
y_labels <- c("Nunavut", "Yukon", "Prince Edward Island", "Quebec", 
              "Northwest Territories", "Saskatchewan", "Manitoba",
              "Alberta", "Nova Scotia", "New Brunswick", "British Columbia",
              "Newfoundland & Labrador")

orplot(expglm_df, slice_range=69:80, ref_level="Ontario", sorted=TRUE, prefix="province", ylab="Province")
```


```{r gen}
y_labels <- c("2nd generation", "1st generation")

orplot(expglm_df, slice_range=45:46, ref_level="3rd generation (born in Canada, both parents born in Canada") +
  scale_y_discrete(labels = rev(y_labels))
```

```{r ed}
orplot(expglm_df, slice_range=47:58, ref_level="No formal education", sorted=TRUE, prefix="education", ylab="Education")
```

```{r mar}
orplot(expglm_df, slice_range=81:84, ref_level="Married", sorted=TRUE, prefix="mar_stat", ylab="Marital status")
```

```{r kids}
orplot(expglm_df, slice_range=85:86, ref_level="No kids")
```

```{r visible_minority}
orplot(expglm_df, slice_range=27:39, ref_level="Not a visible minority", sorted=TRUE)
```

```{r employ}
orplot(expglm_df, slice_range=43:44, ref_level="Full-time work")
```

#Session info

```{r devtools}
devtools::session_info()
```
